@if (ViewBag.Mode == "S")
{
    <input type="hidden" id="hdnMode" value="Sending" />
}
else
{
    <input type="hidden" id="hdnMode" value="Receiving" />
}
<style>
    #tblSHP tbody > tr > td,
    #tblEXP tbody > tr > td,
    #tblCFSCode tbody > tr > td {
        cursor: pointer;
    }
    #tblCont tbody td{
        vertical-align: top;
    }
      #tblCont1 tbody td{
        vertical-align: top;
    }
</style>
<input type="hidden" id="hdnContDet" value="" />
<input type="hidden" id="hdnAck" value="" />
<div class="container-fluid">
    <div class="row">
        <div class="col-md-offset-0-5 col-md-11">
            <div class="Head_h4">
                <div class="row">
                    <div class="col-md-12">
                        <h4>ICE Gate Report Export</h4>
                    </div>
                </div>
                <div class="row Form_Space_top">
                    <div class="form-group Form_Input">
                        <div class="col-md-1">
                            <div class="boolean-container">
                                @Html.RadioButton("Sending", "S", new { @id = "Sending", @onchange = "ChangeMode('S')" })
                                <label for="Sending"><i class="circle"></i><span>Sending</span></label>
                            </div>
                        </div>
                        <div class="col-md-1-5">
                            <div class="boolean-container">
                                @Html.RadioButton("Receiving", "R", new { @id = "Receiving", @onchange = "ChangeMode('R')" })
                                <label for="Receiving"><i class="circle"></i><span>Receiving</span></label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row Form_Space_top">
                    <div class="form-group Form_Input">
                        <div class="col-md-1 col_cus_2 padding_rt">
                            <label>From Date </label><span class="LabelColon">:</span>
                        </div>
                        <div class="col-md-2-5 Date_Img">
                            @Html.TextBox("FromDate", "", new { @class = "form-control input-sm", @readonly = true })
                        </div>
                        <div class="col-md-1 col-md-offset-1 col_cus_2 padding_rt">
                            <label>To Date : </label>
                        </div>
                        <div class="col-md-2-5 Date_Img">
                            @Html.TextBox("ToDate", "", new { @class = "form-control input-sm", @readonly = true })
                        </div>
                        <div class="col-md-offset-1-5 col-md-2-5">
                            <input style="width:100%; margin:0;" type="button" id="btnAdvSearch" class="btn log_Btn_sm" value="Advanced Search" onclick="$('.AdvDiv').toggle(); $('#ContainerNo,#CFSCode,#OBLSB,#ShippingLineName,#ShippingLineId,#Exporter,#ExporterId').val('')" />
                        </div>
                    </div>
                </div>

                <div class="row AdvDiv">
                    <div class="stoke SignUp_space_bottom SignUp_space_top"></div>
                </div>
                <div class="row Form_Space_top AdvDiv">
                    <div class="form-group Form_Input">
                        <div class="col-md-1-5 col_cus_2 padding_rt">
                            <label>Container No. :</label>
                        </div>
                        <div class="col-md-2-5">
                            @Html.TextBox("ContainerNo", "", new { @class = "form-control input-sm", @readonly = true })
                            @Html.Hidden("CFSCode", "")
                            <span class="search"><i class="fa fa-search" aria-hidden="true" data-toggle="modal" onclick="LoadCFSCode();" data-target="#CFSCodeModal"></i></span>
                        </div>
                        <div class="col-md-1 col-md-offset-4-5 col_cus_2 padding_rt">
                            <label>SB No. :</label>
                        </div>
                        <div class="col-md-2-5">
                            @Html.TextBox("OBLSB", "", new { @class = "form-control input-sm" })
                        </div>
                    </div>
                </div>
                <div class="row Form_Space_top AdvDiv">
                    <div class="form-group Form_Input">
                        <div class="col-md-1-5 col_cus_2">
                            <label>Shipping Line:</label>
                        </div>
                        <div class="col-md-10-5 col_cus_10">
                            @Html.Hidden("ShippingLineId")
                            @Html.TextBox("ShippingLineName", "", new { @class = "form-control input_sm", @readonly = true })
                            <span class="search"><i class="fa fa-search" aria-hidden="true" data-toggle="modal" onclick="LoadMoreSHP();" id="shipping" data-target="#ShippingLineModal"></i></span>
                        </div>
                    </div>
                </div>
                <div class="row Form_Space_top AdvDiv">
                    <div class="form-group Form_Input">
                        <div class="col-md-1-5 col_cus_2">
                            <label>Exporter :</label>
                        </div>
                        <div class="col-md-10-5 col_cus_10">
                            @Html.TextBox("Exporter", "", new { @class = "form-control input-sm", @readonly = true })
                            <span class="search"><i class="fa fa-search" aria-hidden="true" data-toggle="modal" onclick="LoadMoreEXP();" data-target="#ExporterModal"></i></span>
                            @Html.Hidden("ExporterId")
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="stoke SignUp_space_bottom SignUp_space_top"></div>
                </div>
                <div class="row">
                    <div class="col-md-offset-3 col-md-1-5 SignUp_space_bottom">
                        <input style="width:100%; margin:0;" type="button" id="btnSearch" class="btn log_Btn_sm" value="Search" onclick="SearchedData()" />
                    </div>
                    <div class="col-md-2 SignUp_space_bottom">
                        <input style="width:100%; margin:0;" type="button" id="btnPdfPrint" class="btn log_Btn_sm" value="Send to PDF" disabled onclick="GeneratePDF()" />
                    </div>
                    <div class="col-md-2 SignUp_space_bottom">
                        <input style="width:100%; margin:0;" type="button" id="btnExcelPrint" class="btn log_Btn_sm" value="Send to Excel" disabled onclick="GenerateExcel()" />
                    </div>
                </div>
                <div class="row">
                    <table id="tblCont" class="table table-bordered table-striped dataTable" style="font-size:8pt; display:none; overflow: hidden; table-layout: fixed; word-break: break-word;">
                        <thead>
                            <tr>
                                <td style="width:30px;">#</td>
                                <td style="width:70px;">Ack Received Date</td>
                                <td style="width:70px;">First Message On</td>
                                <td style="width:85px;">Container</td>
                                <td style="width:100px;">SB No.</td>
                                <td style="width:100px;">Shipping Line</td>
                                <td style="width:150px;">Exporter</td>
                                <td style="width:70px;">Last Message On</td>
                                <td style="width:80px;">ICE Gate Status</td>
                                <td style="width:60px;">Remarks</td>
                                <td style="width:100px">E07 File Name</td>
                                <td style="width:40px;">View Ack Details</td>
                                <td style="width:40px;">Download E07</td>
                                <td style="width:40px;">Resend</td>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="row">
                    <table id="tblCont1" class="table table-bordered table-striped dataTable" style="font-size:8pt; display:none; overflow: hidden; table-layout: fixed; word-break: break-word;">
                        <thead>
                            <tr>
                                <td style="width:30px;">#</td>
                             @* <td style="width:70px;">Ack Received Date</td>*@
                                <td style="width:70px;">First Message On</td>
                                <td style="width:85px;">Container</td>
                                <td style="width:100px;">SB No.</td>
                                <td style="width:100px;">Shipping Line</td>
                                <td style="width:150px;">Exporter</td>
                                <td style="width:70px;">Last Message On</td>
                                <td style="width:80px;">ICE Gate Status</td>
                                <td style="width:60px;">Remarks</td>
                                <td style="width:100px">E07 File Name</td>
                                <td style="width:40px;">View Ack Details</td>
                                <td style="width:40px;">Download E07</td>
                                <td style="width:40px;">Resend</td>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
            </div>

            <div class="logSuccMsg" id="DivMsg" style="background-color:transparent"></div>
        </div>
    </div>
</div>
<div class="modal fade" id="CFSCodeModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content popup_modal">
            <div class="modal-header popup_header">
                <button type="button" class="close" data-dismiss="modal"><i class="fa fa-times" aria-hidden="true"></i></button>
                <h4 class="modal-title">List of Container no. and CFSCode</h4>
            </div>
            <div class="modal-body popup_body" style="position:relative;">
                <input placeholder="Search By Container no. or CFSCode" id="SearchCFSCode" type="text" />
                <table class="table table-striped table-bordered dataTable tblhd" style="width:100%; margin:0 !important; border-bottom:0; padding:0;">
                    <thead>
                        <tr>
                            <th colspan="6" width="50%">Container no.</th>
                            <th colspan="6" width="50%">CFSCode</th>
                        </tr>
                    </thead>
                </table>
                <div id="slim_scrollCFS">
                    <table class="table dataTable table-bordered table-striped slim_tble" id="tblCFSCode">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-md-6">

                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn log_Btn_sm" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ExporterModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content popup_modal">
            <div class="modal-header popup_header">
                <button type="button" class="close" onclick="CloseEXP()"><i class="fa fa-times" aria-hidden="true"></i></button>
                <h4 class="modal-title">List of Exporter Name</h4>
            </div>
            <div class="modal-body popup_body" style="position:relative;">
                <input placeholder="Search By Party Code" id="EXPCode" type="text" />
                <span class="search" style="top: 18px;"><i class="fa fa-search" aria-hidden="true" onclick="SearchEXP()"></i></span>
                <table class="table table-striped table-bordered dataTable tblhd" style="width:100%; margin:0 !important; border-bottom:0; padding:0;">
                    <thead>
                        <tr>
                            <th colspan="8" width="80%">Party Name</th>
                            <th colspan="4" width="20%">Party Code</th>
                        </tr>
                    </thead>
                </table>
                <div id="slim_scrollEXP">
                    <table class="table dataTable table-bordered table-striped slim_tble" id="tblEXP">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-md-6">
                        <button type="button" style="width:100%; margin-left:0;" onclick="LoadMoreEXP()" class="btn log_Btn_sm" id="btnEXP">Load More Data</button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn log_Btn_sm" onclick="CloseEXP()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="ShippingLineModal" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content popup_modal">
            <div class="modal-header popup_header">
                <button type="button" class="close" onclick="CloseSHP()"><i class="fa fa-times" aria-hidden="true"></i></button>
                <h4 class="modal-title">List of Shipping Line Name</h4>
            </div>
            <div class="modal-body popup_body" style="position:relative;">
                <input placeholder="Search By Party Code" id="SHPCode" type="text" />
                <span class="search" style="top: 18px;"><i class="fa fa-search" aria-hidden="true" onclick="SearchSHP()"></i></span>
                <table class="table table-striped table-bordered dataTable tblhd" style="width:100%; margin:0 !important; border-bottom:0; padding:0;">
                    <thead>
                        <tr>
                            <th colspan="8" width="80%">Shipping Line Name</th>
                            <th colspan="4" width="20%">Party Code</th>
                        </tr>
                    </thead>
                </table>
                <div id="slim_scrollSHP">
                    <table class="table dataTable table-bordered table-striped slim_tble" id="tblSHP">
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <div class="row">
                    <div class="col-md-6">
                        <button type="button" style="width:100%; margin-left:0;" onclick="LoadMoreSHP()" class="btn log_Btn_sm" id="btnSHP">Load More Data</button>
                    </div>
                    <div class="col-md-6">
                        <button type="button" class="btn log_Btn_sm" onclick="CloseSHP()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="AckModal" role="dialog">
    <div class="modal-dialog modal-lg" style="word-break: break-word;">
        <div class="modal-content popup_modal">
            <div class="modal-header popup_header">
                <button type="button" class="close"><i class="fa fa-times" data-dismiss="modal" aria-hidden="true"></i></button>
                <h4 class="modal-title">Acknowledgement Details</h4>
            </div>
            <div class="modal-body popup_body" style="position:relative;">
                <table class="table table-striped table-bordered dataTable" id="tblAck" style="width:100%;">
                    <thead>
                        <tr>
                            <th width="35%">File Name</th>
                            <th width="20%">Ack Received Date</th>
                            <th width="20%">Error Code</th>
                            <th width="15%">Download</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript" src="/scripts/jquery.nicescroll.min.js"></script>
<script>
    $(function () {
        $('.AdvDiv').hide();
        $('#slim_scrollCFS').slimScroll({
            allowPageScroll: true
        });
        $('#slim_scrollEXP').slimScroll({
            allowPageScroll: true
        });
        $('#slim_scrollSHP').slimScroll({
            allowPageScroll: true
        });

        if ($('#hdnMode').val() == 'Sending')
            $('#Sending').prop("checked", true);
        else
            $('#Receiving').prop("checked", true);
    });
    $('#FromDate').datepicker({
        dateFormat: "dd/mm/yy",
        showOn: "button",
        buttonImage: "/Content/images/calendar.png",
        buttonImageOnly: true,
        buttonText: "Select date",
        changeMonth: true,
        changeYear: true,
        showAnima: "fadein",
        onClose: function () {
            $("[data-valmsg-for='FromDate']").html('');
        }
    });
    $('#ToDate').datepicker({
        dateFormat: "dd/mm/yy",
        showOn: "button",
        buttonImage: "/Content/images/calendar.png",
        buttonImageOnly: true,
        buttonText: "Select date",
        changeMonth: true,
        changeYear: true,
        showAnima: "fadein",
        onClose: function () {
            $("[data-valmsg-for='ToDate']").html('');
        }
    });
    function LoadCFSCode() {
        var Module = 'E';
        $.ajax({
            url: '/Icegate/Loni_Icegate/GetContainerList',
            type: 'GET',
            data: { 'Module': Module },
            success: function (data) {
                if (data.Status == 1) {
                    var html = '';
                    $.each(data.Data, function (i, elem) {
                        html += '<tr onclick=SelectContainer(' + i + ')><td  colspan="6" width="50%">' + elem.ContainerNo + '</td><td  colspan="6" width="50%">' + elem.CFSCode + '</td></tr>';
                    });
                    $('#tblCFSCode tbody').html(html);
                }
                else {
                    $('#tblCFSCode tbody').html('');
                }
            }
        });
    }
    function SelectContainer(i) {
        $('#CFSCode').val($('#tblCFSCode tbody tr:eq(' + i + ') td:eq(1)').text());
        $('#ContainerNo').val($('#tblCFSCode tbody tr:eq(' + i + ') td:eq(0)').text());
        $('#CFSCodeModal').modal('hide');
    }
    $('#SearchCFSCode').keyup(function () {
        var val = $(this).val().toLowerCase();
        if (val == "")
            $('#tblCFSCode > tbody > tr').show();
        else {
            $('#tblCFSCode >tbody > tr').each(function () {
                var text = $(this).text().toLowerCase();
                (text.indexOf(val) >= 0 ? $(this).show() : $(this).hide());
            });
        }
    });
    function ChangeModule(module) {
        $('#DivBody').load('/Icegate/Loni_Icegate/IceGateImportReport?Mode=' + mode);
    }
    function ChangeMode(mode) {
        $('#DivBody').load('/Icegate/Loni_Icegate/IceGateExportReport?Mode=' + mode);
    }
    function SearchedData()
    {
        var From = $('#FromDate').val();
        var To = $('#ToDate').val();

        var SF = From.split('/');
        var ST = To.split('/');
        var FromDate = new Date(SF[2], (Number(SF[1]) - 1), SF[0]);
        var ToDate = new Date(ST[2], (Number(ST[1]) - 1), ST[0]);

        if (From == '') {
            alert('Select From date');
            return false;
        }
        else if (To == '') {
            alert('Select To date');
            return false;
        }
        else if (FromDate > ToDate) {
            alert('To date must be greater than From date');
            return false;
        }
        else {
            $('#tblCont tbody').html('');
            $('#tblCont').css("display", "none");
            $('#tblCont1 tbody').html('');
            $('#tblCont1').css("display", "none");
            var Token = $('input[name="__RequestVerificationToken"]').val();
            var mode = ($('#Sending').is(':checked') == true ? 'S' : 'R');
            $.ajax({
                url: '/Icegate/Loni_Icegate/ExportE07Report',
                type: 'POST',
                data: {
                    FromDate: From,
                    ToDate: To,
                    Mode: ($('#Sending').is(':checked') == true ? 'S' : 'R'),
                    CFSCode: $('#CFSCode').val(),
                    OBL: $('#OBLSB').val(),
                    ShippingId: $('#ShippingLineId').val(),
                    ImpExpId: $('#ExporterId').val()
                },
                headers: { "__RequestVerificationToken": Token },
                success: function (data) {
                    if (data.Status == 1) {
                        //$('#tblCont').css("display", "block");
                        $('#hdnAck').val(JSON.stringify(data.Data.LstContAck));
                        $('#hdnContDet').val(JSON.stringify(data.Data.LstCont));
                        console.log(data.Data);
                        debugger;
                        if (mode == 'S') {
                            debugger;
                            $('#tblCont1').css("display", "block");
                            $('#tblCont').css("display", "none");
                            ModifyTable1();
                        }
                        if (mode == 'R') {
                            $('#tblCont').css("display", "block");
                            $('#tblCont1').css("display", "none");
                            ModifyTable();
                        }
                       

                        

                        $('#btnPdfPrint,#btnExcelPrint').prop('disabled', false);
                    }
                    else {
                        $('#tblCont tbody').html('');
                        $('#hdnAck,#hdnContDet').val('');
                        $('#tblCont').css("display", "none");
                        $('#tblCont1 tbody').html('');
                        $('#hdnAck,#hdnContDet').val('');
                        $('#tblCont1').css("display", "none");
                        $('#btnPdfPrint,#btnExcelPrint').prop('disabled', true);
                        alert('No data found');
                    }
                }
            });
        }
    }
    Array.prototype.unique = function () {
        let arr = [];
        for (let i = 0; i < this.length; i++) {
            if (this[i] != "") {
                if (!arr.includes(this[i])) {
                    arr.push(this[i]);
                }
            }
        }
        return arr;
    }
    function UniqueCFSCodeFileCode(json) {
        var out = [];
        for (var i = 0; i < json.length; i++) {
            if (out.filter(x=>x.CFSCode == json[i].CFSCode && x.FileCode == json[i].FileCode).length == 0 ||
                out.filter(x=>x.CFSCode == json[i].CFSCode && x.FileCode == json[i].FileCode).length == undefined)
                out.push(json[i]);
        }
        return out;
    }
    function ModifyTable() {
        try {
            var LstCont = JSON.parse($('#hdnContDet').val());
            var LstAck = JSON.parse($('#hdnAck').val());
            var html = '';
            var contJson = UniqueCFSCodeFileCode(LstCont.map(obj=>({ CFSCode: obj.CFSCode, FileCode: obj.FileCode })));
            var count = 1;
            $.each(contJson, function (i, elem) {
                var arraydet = LstCont.filter(x=>x.CFSCode == elem.CFSCode && x.FileCode == elem.FileCode);
                var Imp = '', Sla = '', obl = '', remarks = '';
                $.each((arraydet.map(function (d) { return d.Importer; })).unique(), function (i, item) { Imp = (item == "" ? Imp : (Imp + item + " , ")) });
                $.each((arraydet.map(function (d) { return d.SLA; })).unique(), function (i, item) { Sla = (item == "" ? Sla : (Sla + item + " , ")) });
                $.each((arraydet.map(function (d) { return d.OBLNo; })).unique(), function (i, item) { obl = (item == "" ? obl : (obl + item + " , ")) });

                if (LstAck.filter(x=>x.FileCode == arraydet[0].FileCode).length > 0) {
                    $.each((LstAck.filter(x=>x.FileCode == arraydet[0].FileCode).map(x=>x.ErrorCode)).unique(), function (i, item) {
                        remarks = (item.ErrorCode == "" ? remarks : remarks + "  " + item);
                    });
                }

                html += "<tr><td>" + count + "</td>";
                html += "<td>" + arraydet[0].AckRecvDate + "</td>";
                html += "<td>" + arraydet[0].DateofMsg + "</td>";
                html += "<td>" + arraydet[0].ContainerNo + "</td>";
                html += "<td>" + obl + "</td>";
                html += "<td>" + Sla + "</td>";
                html += "<td>" + Imp + "</td>";
                html += "<td>" + arraydet[0].SendOn + "</td>";

                html += "<td>" + arraydet[0].AckStatus + "</td>";
                html += "<td>" + (arraydet[0].AckStatus == 'Successful' ? '' : remarks) + "</td>";
                html += "<td>" + arraydet[0].FileName + "</td>";
                if (LstAck.filter(x=>x.FileCode == arraydet[0].FileCode).length > 0) {
                    html += "<td align='center'><a href='#' onclick='ViewAck(" + arraydet[0].FileCode + ")'><i class='fa fa-search-plus Edit' aria-hidden='true'></i></a></td>";
                }
                else {
                    html += "<td></td>";
                }
                html += "<td align='center'><a href='#' onclick='DownloadE07(&quot;" + arraydet[0].FileName + "&quot;)'><i class='fa fa-download Edit' aria-hidden='true'></i></a></td>";
                html += "<td align='center'><a href='#' onclick='ResendE07(&quot;" + arraydet[0].FileName + "&quot;,&quot;" + arraydet[0].FileCode + "&quot;,&quot;" + arraydet[0].ContainerNo + "&quot;,&quot;" + arraydet[0].CFSCode + "&quot;)'><i class='fa fa-repeat Edit' aria-hidden='true'></i></a></td>'";
                html += "</tr>";
                count++;
            });
            $('#tblCont tbody').html(html);
            $('#tblCont').css("display", "block");
        } catch (e) {
            console.log(e.message);
        }

    }
    function ModifyTable1()
    {
        try {
            var LstCont = JSON.parse($('#hdnContDet').val());
            var LstAck = JSON.parse($('#hdnAck').val());
            var html = '';
            var contJson = UniqueCFSCodeFileCode(LstCont.map(obj=>({ CFSCode: obj.CFSCode, FileCode: obj.FileCode })));
            var count = 1;
            $.each(contJson, function (i, elem) {
                var arraydet = LstCont.filter(x=>x.CFSCode == elem.CFSCode && x.FileCode==elem.FileCode);
                var Imp = '', Sla = '', obl = '', remarks = '';
                $.each((arraydet.map(function (d) { return d.Importer; })).unique(), function (i, item) { Imp = (item == "" ? Imp : (Imp + item + " , ")) });
                $.each((arraydet.map(function (d) { return d.SLA; })).unique(), function (i, item) { Sla = (item == "" ? Sla : (Sla + item + " , ")) });
                $.each((arraydet.map(function (d) { return d.OBLNo; })).unique(), function (i, item) { obl = (item == "" ? obl : (obl + item + " , ")) });

                if (LstAck.filter(x=>x.FileCode == arraydet[0].FileCode).length > 0) {
                    $.each((LstAck.filter(x=>x.FileCode == arraydet[0].FileCode).map(x=>x.ErrorCode)).unique(), function (i, item) {
                        remarks = (item.ErrorCode == "" ? remarks : remarks + "  " + item);
                              });
                }

                html += "<tr><td>" + count + "</td>";
               // html += "<td>" + arraydet[0].AckRecvDate + "</td>";
                html += "<td>" + arraydet[0].DateofMsg + "</td>";
                html += "<td>" + arraydet[0].ContainerNo + "</td>";
                html += "<td>" + obl + "</td>";
                html += "<td>" + Sla + "</td>";
                html += "<td>" + Imp + "</td>";
                html += "<td>" + arraydet[0].SendOn + "</td>";

                html += "<td>" + arraydet[0].AckStatus + "</td>";
                html += "<td>" + (arraydet[0].AckStatus == 'Successful' ? '' : remarks) + "</td>";
                html += "<td>" + arraydet[0].FileName + "</td>";
                if (LstAck.filter(x=>x.FileCode == arraydet[0].FileCode).length > 0) {
                    html += "<td align='center'><a href='#' onclick='ViewAck(" + arraydet[0].FileCode + ")'><i class='fa fa-search-plus Edit' aria-hidden='true'></i></a></td>";
                }
                else {
                    html += "<td></td>";
                }
                html += "<td align='center'><a href='#' onclick='DownloadE07(&quot;" + arraydet[0].FileName + "&quot;)'><i class='fa fa-download Edit' aria-hidden='true'></i></a></td>";
                html += "<td align='center'><a href='#' onclick='ResendE07(&quot;" + arraydet[0].FileName + "&quot;,&quot;" + arraydet[0].FileCode + "&quot;,&quot;" + arraydet[0].ContainerNo + "&quot;,&quot;" + arraydet[0].CFSCode + "&quot;)'><i class='fa fa-repeat Edit' aria-hidden='true'></i></a></td>'";
                html += "</tr>";
                count++;
            });
            $('#tblCont1 tbody').html(html);
            $('#tblCont1').css("display", "block");
        } catch (e) {
            console.log(e.message);
        }

    }
    function ViewAck(FileCode) {
        var LstAck = JSON.parse($('#hdnAck').val());
        var html = '';
        $.each(LstAck.filter(x=>x.FileCode == FileCode), function (i, elem) {
            html += '<tr><td>' + elem.FileName + '</td>';
            html += '<td>' + elem.AckRecvDate + '</td>';
            html += '<td>' + elem.ErrorCode + '</td>';
            html += '<td align="center"><a href="#" onclick="DownloadAck(&quot;' + elem.FileName + '&quot;)"><i class="fa fa-download Edit" aria-hidden="true"></i></a></td></tr>';
        });
        $('#tblAck tbody').html(html);
        $("#AckModal").modal("show");
    }
    function DownloadAck(FileName) {
        $.ajax({
            url: '/Icegate/Loni_Icegate/DownloadFile',
            type: 'POST',
            data: {
                "FilePath": "'@System.Configuration.ConfigurationManager.AppSettings["Ppg_ReportfileAckbck"].ToString()'",
                "FileName": FileName
            },
            success: function (data) {
                if (data.Status == 1)
                    window.open(data.Data);
            }
        });
    }
    function DownloadE07(FileName) {
        $.ajax({
            url: '/Icegate/Loni_Icegate/DownloadFile',
            type: 'POST',
            data: {
                "FilePath": "'@System.Configuration.ConfigurationManager.AppSettings["Ppg_MsgFileContExit"].ToString()'",
                "FileName": FileName
            },
            success: function (data) {
                if (data.Status == 1)
                    window.open(data.Data);
            }
        });
    }
    function ResendE07(FileName, FileCode, ContainerNo, CFSCode) {
        $.ajax({
            url: '/Icegate/Loni_Icegate/ResendE07',
            type: 'POST',
            data: {
                "FilePath": "'@System.Configuration.ConfigurationManager.AppSettings["Ppg_MsgFileContExit"].ToString()'",
                "FileName": FileName,
                "FileCode": FileCode,
                "ContainerNo": ContainerNo,
                "CFSCode": CFSCode
            },
            success: function (data) {
                if (data.Status == 1)
                    alert('File Resend Successful');
            }
        });
    }
    function GeneratePDF() {
        var LstCont = JSON.parse($('#hdnContDet').val());
        var LstContAck = JSON.parse($('#hdnAck').val());
        if ($('#hdnContDet').val() == '')
            alert('No data');
        else
        {
            $.ajax({
                url: '/Icegate/Loni_Icegate/GenerateE07File',
                type: 'POST',
                data: {
                    "LstCont": LstCont,
                    "LstContAck": LstContAck,
                    "FromDate": $('#FromDate').val(),
                    "ToDate": $('#ToDate').val(),
                    "Mode": ($('#Sending').is(':checked') ? 'S' : 'R')
                },
                success: function (data) {
                    if (data.Status == 1)
                        window.open(data.Data);
                    else alert('No Data');
                }
            });
        }
    }
    function GenerateExcel() {
        var LstCont = JSON.parse($('#hdnContDet').val());
        var LstContAck = JSON.parse($('#hdnAck').val());
        if ($('#hdnContDet').val() == '')
            alert('No data');
        else
        {
            $.ajax({
                url: '/Icegate/Loni_Icegate/GenerateE07ExcelFile',
                type: 'POST',
                data: {
                    "LstCont": LstCont,
                    "LstContAck": LstContAck,
                    "FromDate": $('#FromDate').val(),
                    "ToDate": $('#ToDate').val(),
                    "Mode": ($('#Sending').is(':checked') ? 'S' : 'R')
                },
                success: function (data) {
                    if (data.Status == 1)
                        window.open(data.Data);
                    else alert('No Data');
                }
            });
        }
    }
</script>
<script>
    function debounce(func, wait, immediate) {
        var timeout;
        return function () {
            var context = this, args = arguments;
            var later = function () {
                timeout = null;
                if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
        };
    }
    var EXPPage = -1;
    function CloseEXP() {
        EXPPage = -1;
        $('#tblEXP tbody').html('');
        $('#EXPCode').val('');
        $("#ExporterModal").modal("hide");
    }
    function LoadMoreEXP() {
        EXPPage++;
        jsoninput = { PartyCode: "", Page: EXPPage, Exporter: 1 };
        $.ajax({
            url: '/Icegate/Loni_Icegate/Eximtraderlist',
            type: 'GET',
            data: jsoninput,
            success: function (data) {
                if (data.Status == 1) {
                    var html = '';
                    $.each(data.Data.LstParty, function (item, elem) {
                        html += '<tr onclick="selectExporter(' + elem.EximTraderId + ',&quot;' + elem.EximTraderName + '&quot;)"><td colspan="8" width="80%" class="txt_wrp">' + elem.EximTraderName + '</td><td colspan="4" width="20%" class="txt_wrp">' + elem.EximTraderAlias + '</td></tr>';
                    });
                    if ($('#tblEXP tbody tr').length > 0)
                        $('#tblEXP tbody').append(html);
                    else $('#tblEXP tbody').html(html);
                    if (data.Data.State == true)
                        $('#btnEXP').prop('disabled', false);
                    else $('#btnEXP').prop('disabled', true);
                }
            }
        });
    }
    function SearchEXP() {
        EXPPage = -1;
        jsoninput = { PartyCode: $('#EXPCode').val(), Page: EXPPage, Exporter: 1 };
        var PayeeCode = $('#EXPCode').val();
        $.ajax({
            url: '/Icegate/Loni_Icegate/Eximtraderlist',
            type: 'GET',
            data: jsoninput,
            success: function (data) {
                if (data.Status == 1) {
                    var html = '';
                    $.each(data.Data.LstParty, function (item, elem) {
                        html += '<tr onclick="selectExporter(' + elem.EximTraderId + ',&quot;' + elem.EximTraderName + '&quot;)"><td colspan="8" width="80%" class="txt_wrp">' + elem.EximTraderName + '</td><td colspan="4" width="20%" class="txt_wrp">' + elem.EximTraderAlias + '</td></tr>';
                    });

                    $('#tblEXP tbody').html(html);

                    if (data.Data.State == true)
                        $('#btnEXP').prop('disabled', false);
                    else $('#btnEXP').prop('disabled', true);
                }
            }
        });
    }
    function selectExporter(EximTraderId, EximTraderName) {
        $('#Exporter').val(EximTraderName);
        $('#ExporterId').val(EximTraderId);
        //$("#ExporterModal").modal("hide");
        $('[data-valmsg-for="Exporter"]').html('<span></span>');
        CloseEXP();
    }

    document.getElementById('EXPCode').addEventListener('keyup', debounce(function () {
        if (document.getElementById('EXPCode').value != "")
            SearchEXP();
        else {
            $('#tblEXP tbody').html('');
            LoadMoreEXP();
        }
    }, 800));

    var SHPPage = -1;
    function CloseSHP() {
        SHPPage = -1;
        $('#tblSHP tbody').html('');
        $('#SHPCode').val('');
        $("#ShippingLineModal").modal("hide");
    }
    function LoadMoreSHP() {
        SHPPage++;
        $.ajax({
            url: '/Icegate/Loni_Icegate/Eximtraderlist',
            type: 'GET',
            data: { PartyCode: "", Page: SHPPage, ShippingLine: 1 },
            success: function (data) {
                if (data.Status == 1) {
                    var html = '';
                    $.each(data.Data.LstParty, function (item, elem) {
                        html += '<tr onclick="selectShippingLine(' + elem.EximTraderId + ',&quot;' + elem.EximTraderName + '&quot;)"><td colspan="8" width="80%" class="txt_wrp">' + elem.EximTraderName + '</td><td colspan="4" width="20%" class="txt_wrp">' + elem.EximTraderAlias + '</td></tr>';
                    });
                    if ($('#tblSHP tbody tr').length > 0)
                        $('#tblSHP tbody').append(html);
                    else $('#tblSHP tbody').html(html);
                    if (data.Data.State == true)
                        $('#btnSHP').prop('disabled', false);
                    else $('#btnSHP').prop('disabled', true);
                }
            }
        });
    }
    function SearchSHP() {
        SHPPage = -1;
        var PayeeCode = $('#SHPCode').val();
        $.ajax({
            url: '/Icegate/Loni_Icegate/Eximtraderlist',
            type: 'GET',
            data: { PartyCode: PayeeCode, Page: 0, ShippingLine: 1 },
            success: function (data) {
                if (data.Status == 1) {
                    var html = '';
                    $.each(data.Data.LstParty, function (item, elem) {
                        html += '<tr onclick="selectShippingLine(' + elem.EximTraderId + ',&quot;' + elem.EximTraderName + '&quot;)"><td colspan="8" width="80%" class="txt_wrp">' + elem.EximTraderName + '</td><td colspan="4" width="20%" class="txt_wrp">' + elem.EximTraderAlias + '</td></tr>';
                    });

                    $('#tblSHP tbody').html(html);

                    if (data.Data.State == true)
                        $('#btnSHP').prop('disabled', false);
                    else $('#btnSHP').prop('disabled', true);
                }
            }
        });
    }
    document.getElementById('SHPCode').addEventListener('keyup', debounce(function () {
        if (document.getElementById('SHPCode').value != "")
            SearchSHP();
        else {
            $('#tblSHP tbody').html('');
            LoadMoreSHP();
        }
    }, 800));
    function selectShippingLine(id, name) {
        $('#ShippingLineName').val(name);
        $('#ShippingLineId').val(id);
        //$("#ShippingLineModal").modal("hide");
        CloseSHP();
    }
</script>